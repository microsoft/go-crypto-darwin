# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

on: [push, pull_request]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

name: Test
jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        go-version: [1.24.x, 1.25.x]
        macos-version: [macos-13, macos-14, macos-15, macos-26]
        cgo: [1]
        include:
          - go-version: 1.26.x
            macos-version: macos-13
            cgo: 0
          - go-version: 1.26.x
            macos-version: macos-14
            cgo: 0
          - go-version: 1.26.x
            macos-version: macos-15
            cgo: 0
          - go-version: 1.26.x
            macos-version: macos-26
            cgo: 0
    runs-on: ${{ matrix.macos-version }}
    steps:
      - uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        if: matrix.go-version != '1.26.x'
        with:
          go-version: ${{ matrix.go-version }}

      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      # TODO: Remove this when 1.26 is released
      - name: Setup gotip
        if: matrix.go-version == '1.26.x'
        uses: ./.github/actions/gotip
        with:
          macos-version: ${{ matrix.macos-version }}

      - name: Run Go Tests
        run: CGO_ENABLED=${{ matrix.cgo }} ${{ matrix.go-version == '1.26.x' && 'gotip' || 'go' }} test -gcflags=all=-d=checkptr -count 10 -v ./...

      - name: Run Swift Tests
        working-directory: cryptokit
        run: swift test
  verify-reproducible-build:
    runs-on: macos-26
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Backup existing object files
        run: |
          mkdir -p backup
          cp -f internal/cryptokit/CryptoKit_*.syso backup/ 2>/dev/null || true

      - name: Rebuild object files
        run: ./gen-swift-bindings.sh

      - name: Verify object files are reproducible
        run: |
          if ! diff -q backup/CryptoKit_amd64.syso internal/cryptokit/CryptoKit_amd64.syso >/dev/null 2>&1; then
            echo "ERROR: CryptoKit_amd64.syso is not reproducible - the checked-in version differs from the rebuilt version"
            echo "This indicates the object file in the repository is out of sync with the source code"
            echo "Please rebuild using: ./gen-swift-bindings.sh"
            exit 1
          fi
          if ! diff -q backup/CryptoKit_arm64.syso internal/cryptokit/CryptoKit_arm64.syso >/dev/null 2>&1; then
            echo "ERROR: CryptoKit_arm64.syso is not reproducible - the checked-in version differs from the rebuilt version"
            echo "This indicates the object file in the repository is out of sync with the source code"
            echo "Please rebuild using: ./gen-swift-bindings.sh"
            exit 1
          fi
          echo "âœ… Object files are reproducible and match the source code"
  linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version: 1.25

      - name: Run Build
        run: go build ./...

      - name: Run Build (cgoless)
        run: CGO_ENABLED=0 go build ./...
  check-headers:
    strategy:
      fail-fast: false
      matrix:
        macos-version: [macos-13, macos-14, macos-15, macos-26]
    runs-on: ${{ matrix.macos-version }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version: 1.25

      - name: Run go generate
        run: |
          go generate ./...

      - name: Check for any changed files
        run: |
          git diff --exit-code || (echo "Generated files are out of date. Please run 'go generate'." && exit 1)
