# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

name: Test
jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        # TODO: switch to 1.26.x when it is officially released
        go-version: [1.24.x, 1.25.x, "1.26.0-rc.2"]
        macos-version: [macos-14, macos-15, macos-15-intel, macos-26]
        cgo: [0, 1]
        linkmode: ["internal", "external"]
        exclude:
          # CGO_ENABLED=0 is not supported prior to Go 1.26
          - go-version: 1.24.x
            cgo: 0
          - go-version: 1.25.x
            cgo: 0
          # internal linking is not supported prior to Go 1.26
          - go-version: 1.24.x
            linkmode: "internal"
          - go-version: 1.25.x
            linkmode: "internal"
          # external linking is not supported with CGO_ENABLED=0
          - linkmode: "external"
            cgo: 0
    runs-on: ${{ matrix.macos-version }}
    steps:
      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version: ${{ matrix.go-version }}

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Run Go Tests
        run: CGO_ENABLED=${{ matrix.cgo }} go test -gcflags=all=-d=checkptr -ldflags=-linkmode=${{ matrix.linkmode }} -count 10 -v ./...

      - name: Run Swift Tests
        working-directory: cryptokit
        run: swift test

  verify-reproducible-build:
    runs-on: macos-26
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Backup existing object files
        run: |
          mkdir -p backup
          cp -f internal/cryptokit/CryptoKit_*.syso backup/ 2>/dev/null || true

      - name: Rebuild object files
        run: ./gen-swift-bindings.sh

      - name: Verify object files are reproducible
        run: |
          if ! diff -q backup/CryptoKit_amd64.syso internal/cryptokit/CryptoKit_amd64.syso >/dev/null 2>&1; then
            echo "ERROR: CryptoKit_amd64.syso is not reproducible - the checked-in version differs from the rebuilt version"
            echo "This indicates the object file in the repository is out of sync with the source code"
            echo "Please rebuild using: ./gen-swift-bindings.sh"
            exit 1
          fi
          if ! diff -q backup/CryptoKit_arm64.syso internal/cryptokit/CryptoKit_arm64.syso >/dev/null 2>&1; then
            echo "ERROR: CryptoKit_arm64.syso is not reproducible - the checked-in version differs from the rebuilt version"
            echo "This indicates the object file in the repository is out of sync with the source code"
            echo "Please rebuild using: ./gen-swift-bindings.sh"
            exit 1
          fi
          echo "âœ… Object files are reproducible and match the source code"

  linux-x64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version: 1.25

      - name: Run Build
        run: go build ./...

      - name: Run Build (cgoless)
        run: CGO_ENABLED=0 go build ./...

  linux-arm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version: 1.25

      - name: Run Build for ARM32
        run: |
          GOARCH=arm go build ./...

      - name: Run Build for ARM32 (cgoless)
        run: |
          CGO_ENABLED=0 GOARCH=arm go build ./...

  check-headers:
    strategy:
      fail-fast: false
      matrix:
        macos-version: [macos-14, macos-15, macos-15-intel, macos-26]
    runs-on: ${{ matrix.macos-version }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version: 1.25

      - name: Run go generate
        run: |
          go generate ./...

      - name: Check for any changed files
        run: |
          git diff --exit-code || (echo "Generated files are out of date. Please run 'go generate'." && exit 1)

  conclusion:
    needs:
      - test
      - verify-reproducible-build
      - linux-x64
      - linux-arm
      - check-headers
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Result
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" || "${{ contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "One or more jobs failed or were cancelled."
            exit 1
          fi
          echo "All jobs passed."
